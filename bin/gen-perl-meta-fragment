#!/usr/bin/env perl

use 5.010001;
use strict;
use warnings;

use Cwd 'abs_path';
#use File::chdir;
use String::ShellQuote;

die "Usage: $0 <yaml-file>\n" unless @ARGV;
my $src = abs_path($ARGV[0]);
(-f $src) or die "ERROR: src does not exist? $ARGV[0]\n";

my $output = `${\("git log -1 ".shell_quote($src))}`;
$output =~ /^commit (\w+)/
    or die "Can't parse commit ID from 'git log' output\n";
my $rev = $1;
$output =~ /^Date:\s*(.+)/m
    or die "Can't parse date from 'git log' output\n";
my $date = $1;

say "# note: This section is generated by a script. Do not edit manually!";
say "# src-file: $src";
say "# src-revision: $rev";
say "# revision-date: $date";
say "# generate-date: ", scalar(localtime);
say "# generated-by: ", abs_path($0);

# XXX use YAML::Syck + Data::Dump directly to avoid problem when yaml2dd is not
# available
print 'our $meta = ';
system "yaml2dd", $src;
say ";";

